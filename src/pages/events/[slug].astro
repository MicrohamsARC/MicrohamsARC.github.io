---
/**
 * Individual Event Page
 * 
 * Dynamic route for displaying individual event details
 */

import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import EventMap from '../../components/EventMap.astro';
import { publishedFilter } from '../../utils/content';

export const getStaticPaths = (async () => {
  const events = await getCollection('events', publishedFilter);
  return events.map((event) => ({
    params: { slug: event.slug },
    props: { event },
  }));
}) satisfies GetStaticPaths;

const { slug } = Astro.params;
const event = await getEntry('events', slug!);

if (!event) {
  return Astro.redirect('/404');
}

const { Content } = await event.render();

// Format date helper
const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });
};
---

<BaseLayout 
  title={event.data.title}
  description={event.data.description || `Event on ${formatDate(event.data.eventDate)}`}
>
  <article>
    <!-- Event Header -->
    <section class="region--sm">
      <div class="wrapper wrapper--wide">
        <div class="stack-4">
          <!-- Back link -->
          <a href="/events" class="text-sm" style="color: var(--color-text-muted);">← Events</a>

          <!-- Title -->
          <h1>{event.data.title}</h1>

          <!-- Date & Time -->
          <div class="text-sm" style="color: var(--color-text-muted);">
            <time datetime={event.data.eventDate.toISOString()}>
              {formatDate(event.data.eventDate)}
            </time>
            {event.data.startTime && (
              <> · {event.data.startTime}{event.data.endTime && `–${event.data.endTime}`}</>
            )}
          </div>

          <!-- Virtual link - prominent -->
          {event.data.virtualLink && (
            <a href={event.data.virtualLink} class="button" data-variant="primary" data-size="sm" target="_blank" rel="noopener noreferrer" style="align-self: flex-start;">
              Join Virtual Meeting →
            </a>
          )}
        </div>
      </div>
    </section>

    <!-- Event Content -->
    <section class="region">
      <div class="wrapper wrapper--wide">
        <div class="flow flow--lg">
          <Content />
        </div>
      </div>
    </section>

    <!-- Event Map (only if coordinates provided) -->
    {event.data.latitude && event.data.longitude && (
      <section class="region">
        <div class="wrapper wrapper--wide">
          <div class="stack-4">
            <h2 class="text-lg">Location</h2>
            <EventMap 
              location={event.data.location}
              latitude={event.data.latitude}
              longitude={event.data.longitude}
            />
          </div>
        </div>
      </section>
    )}

    <!-- Footer meta -->
    <section class="region--sm">
      <div class="wrapper wrapper--wide">
        <div class="stack-3 text-sm" style="border-block-start: 1px solid var(--color-border); padding-block-start: var(--space-4); color: var(--color-text-muted);">
          <div>{event.data.location}</div>
          
          {event.data.contactPerson && (
            <div>
              Contact: {event.data.contactPerson}
              {event.data.contactEmail && (
                <> — <a href={`mailto:${event.data.contactEmail}`}>{event.data.contactEmail}</a></>
              )}
            </div>
          )}
          
          {event.data.tags && event.data.tags.length > 0 && (
            <ul class="tag-list">
              {event.data.tags.map((tag) => (
                <li><a href={`/tags/${tag}`} class="tag">{tag}</a></li>
              ))}
            </ul>
          )}
        </div>
      </div>
    </section>
  </article>
</BaseLayout>
