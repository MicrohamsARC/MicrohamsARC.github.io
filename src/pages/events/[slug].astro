---
/**
 * Individual Event Page
 *
 * Dynamic route for displaying individual event details
 */

import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import PageLayout from '../../layouts/PageLayout.astro';
import EventLogistics from '../../components/event/EventLogistics.astro';
import EventDateTime from '../../components/event/EventDateTime.astro';
import { publishedFilter } from '../../utils/content';
import { formatEventDate } from '../../utils/event-time';
import { getOnlineMeeting, getVenue } from '../../site.config';

export const getStaticPaths = (async () => {
  const events = await getCollection('events', publishedFilter);
  type Event = (typeof events)[number];
  return events.map((event: Event) => ({
    params: { slug: event.slug },
    props: { event },
  }));
}) satisfies GetStaticPaths;

const { slug } = Astro.params;
const event = await getEntry('events', slug!);

if (!event) {
  return Astro.redirect('/404');
}

const { Content } = await event.render();

// Get timezone options for formatting
const timezoneOptions = { venue: event.data.venue, timezone: event.data.timezone };

// Get venue and meeting configs
const venueConfig = event.data.venue ? getVenue(event.data.venue) : undefined;
const onlineMeetingConfig = event.data.onlineMeeting
  ? getOnlineMeeting(event.data.onlineMeeting)
  : undefined;

// Resolve location: frontmatter overrides venue config
const location = event.data.location || venueConfig?.address;

// Determine event type
const isExternal = !!event.data.eventLink;
const hasInPerson = !!(event.data.venue || event.data.location);
const hasVirtual = !!(onlineMeetingConfig || event.data.teams || event.data.virtualLink);
const virtualUrl = onlineMeetingConfig?.link || event.data.teams?.link || event.data.virtualLink;
---

<PageLayout
  title={event.data.title}
  description={event.data.description ||
    `Event on ${formatEventDate(event.data.eventDate, timezoneOptions)}`}
>
  <article>
    <!-- Event Header -->
    <section class="region--sm">
      <div class="wrapper wrapper--wide">
        <div class="stack-4">
          <!-- Back link -->
          <a href="/events" class="text-sm" style="color: var(--color-text-muted);">← Events</a>

          <!-- Title -->
          <h1>{event.data.title}</h1>

          <!-- Date & Time (interactive toggle) -->
          <EventDateTime
            eventDate={event.data.eventDate}
            startTime={event.data.startTime}
            endTime={event.data.endTime}
            venue={event.data.venue}
            timezone={event.data.timezone}
            class="text-sm"
            style="color: var(--color-text-muted);"
          />

          <!-- Attendance CTAs -->
          <div class="cluster" style="--cluster-gap: var(--space-3);">
            {
              hasInPerson && (
                <a href="#location" class="button" data-variant="primary" data-size="sm">
                  Join In Person
                </a>
              )
            }
            {
              !isExternal && hasVirtual && (
                <a
                  href={virtualUrl}
                  class="button"
                  data-variant={hasInPerson ? 'secondary' : 'primary'}
                  data-size="sm"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Join Online →
                </a>
              )
            }
            {
              isExternal && (
                <a
                  href={event.data.eventLink}
                  class="button"
                  data-variant={hasInPerson ? 'secondary' : 'primary'}
                  data-size="sm"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Event Website →
                </a>
              )
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Event Content + Logistics in unified flow for consistent spacing -->
    <section class="region">
      <div class="wrapper wrapper--wide">
        <div class="flow flow--lg">
          <Content />

          {/* Templated Logistics (venue directions, map, Teams details, disclaimers) */}
          {
            (event.data.venue || event.data.teams || event.data.onlineMeeting) && (
              <EventLogistics
                venue={event.data.venue}
                location={event.data.location}
                latitude={event.data.latitude}
                longitude={event.data.longitude}
                coordFrequency={event.data.coordFrequency}
                onlineMeeting={event.data.onlineMeeting}
                teams={event.data.teams}
                showDisclaimer={event.data.showDisclaimer}
              />
            )
          }
        </div>
      </div>
    </section>

    <!-- Footer meta -->
    <section class="region--sm">
      <div class="wrapper wrapper--wide">
        <div
          class="stack-3 text-sm"
          style="border-block-start: 1px solid var(--color-border); padding-block-start: var(--space-4); color: var(--color-text-muted);"
        >
          {location && <div>{location}</div>}

          {
            event.data.contactPerson && (
              <div>
                Contact: {event.data.contactPerson}
                {event.data.contactEmail && (
                  <>
                    {' '}
                    — <a href={`mailto:${event.data.contactEmail}`}>{event.data.contactEmail}</a>
                  </>
                )}
              </div>
            )
          }

          {
            event.data.tags && event.data.tags.length > 0 && (
              <ul class="tag-list">
                {event.data.tags.map((tag: string) => (
                  <li>
                    <a href={`/tags/${tag}`} class="tag">
                      {tag}
                    </a>
                  </li>
                ))}
              </ul>
            )
          }
        </div>
      </div>
    </section>
  </article>
</PageLayout>
